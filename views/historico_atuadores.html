{% extends "base.html" %}

{% block title %}
<title>Histórico de Atuadores - Sistema IoT</title>
{% endblock %}

{% block content %}

<div class="d-flex justify-content-center align-items-center" style="min-height: 90vh;">
    <div class="card shadow-lg" style="width: 75%; max-width: 900px;">
        <div class="card-header bg-info text-white text-center">
            <h5 class="mb-0"><i class="fas fa-search"></i> Consultar Histórico de Comandos</h5>
        </div>
        <div class="card-body">
            {% with mensagens = get_flashed_messages(with_categories=true) %}
            {% if mensagens %}
                {% for categoria, mensagem in mensagens %}
                    <div class="alert alert-{{ 'danger' if categoria == 'error' else categoria }} alert-dismissible fade show" role="alert">
                        {{ mensagem }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}
            {% endwith %}

            <form action="{{ url_for('obter_comando') }}" method="POST" class="mb-4 text-center">
                <div class="row justify-content-center">
                    <div class="col-md-10 col-lg-8">
                        <div class="form-group mb-4">
                            <label for="atuador_id" class="form-label">
                                <i class="fas fa-thermometer-half"></i>
                            </label>
                            <br>
                            <br>
                            <select class="form-control form-control-lg" id="atuador_id" name="id" required style="font-size: 1.1rem; height: 3.2rem;">
                                <option value="">Escolha Atuador</option>
                                {% for atuador in Atuadores %}
                                    <option value="{{ atuador.id }}">Atuador {{ atuador.id }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-5 col-lg-4">
                        <div class="form-group">
                            <label for="start_date" class="form-label">
                                <i class="fas fa-calendar-alt"></i> Data/Hora Inicial
                            </label>
                            <input type="datetime-local" class="form-control form-control-lg" id="start_date" name="start" required style="font-size: 1.05rem;">
                        </div>
                    </div>
                    <div class="col-md-5 col-lg-4">
                        <div class="form-group">
                            <label for="end_date" class="form-label">
                                <i class="fas fa-calendar-alt"></i> Data/Hora Final
                            </label>
                            <input type="datetime-local" class="form-control form-control-lg" id="end_date" name="end" required style="font-size: 1.05rem;">
                        </div>
                    </div>
                </div>
                <br>
                <div class="form-group text-center mt-3">
                    <button type="submit" class="btn btn-info btn-lg px-5">
                        <i class="fas fa-search"></i> Consultar Histórico
                    </button>
                </div>
            </form>

            {% if read and read|length > 0 %}
                <div class="table-responsive">
                    <table id="view_read" class="table table-striped table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-hashtag"></i> ID do Atuador</th>
                                <th><i class="fas fa-tachometer-alt"></i> Valor</th>
                                <th><i class="fas fa-clock"></i> Data/Hora do Comando</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comando in read %}
                                <tr>
                                    <td class="text-center"><span class="badge badge-primary">{{ comando.atuadores_id }}</span></td>
                                    <td class="text-center"><strong>{{ comando.value }}</strong></td>
                                    <td class="text-center"><i class="fas fa-calendar-day"></i> {{ comando.read_datetime }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Total de registros encontrados: {{ read|length }}
                    </small>
                </div>
            {% elif comand is defined %}
                <div class="text-center py-5">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum registro encontrado</h5>
                    <p class="text-muted">Tente ajustar os filtros de busca ou verifique se há dados para o período selecionado.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.card {
    border: none;
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.form-control:focus {
    border-color: #17a2b8;
    box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
}

.btn {
    border-radius: 25px;
}

.alert {
    border-radius: 10px;
}

.table th,
.table td {
    vertical-align: middle;
}

/* Responsividade e ajustes */
@media (max-width: 768px) {
    .card {
        width: 90% !important;
    }
}
</style>

<script>
// Define as datas padrão (últimas 24 horas)
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const yesterday = new Date(now.getTime() - (24 * 60 * 60 * 1000));
    const formatDateTime = (date) => date.toISOString().slice(0, 16);
    document.getElementById('start_date').value = formatDateTime(yesterday);
    document.getElementById('end_date').value = formatDateTime(now);
});

// Inicializa DataTable, se houver dados
$(document).ready(function() {
    if (document.getElementById('view_read')) {
        $('#view_read').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json"
            },
            "pageLength": 25,
            "responsive": true,
            "order": [[2, 'desc']]
        });
    }
});
</script>

{% endblock %}
